app.service("SharedDataService",["$http","$timeout",function(a,b){this.jsonData=[];var c=this;this.apiDomain="http://localhost:8080",this.doAjax=function(a,b,d,e,f){$.ajax({type:b,url:c.apiDomain+a,data:d,success:function(a,b){"success"==b?null==a?e.call(null,{errMsg:"no results"}):a.errors?e.call(null,{errMsg:"error while getting results"}):e.call(null,a):f.call(null,a)}})},this.registerUser=function(a,b,d){var e="/api/users";c.doAjax(e,"POST",a,function(a){var d={name:a.user_name,user_id:a.user_id};c.setCurrentUser(d),b.call(null,a)},function(a){c.setCurrentUser({}),d.call(null,a)})},this.getUserInfoFromDb=function(a,b,d){var e="/api/users/"+a;c.doAjax(e,"GET",{},function(a){if(a.errMsg)c.setCurrentUser({});else{var d={name:a.name,user_id:a.user_id};c.setCurrentUser(d)}b.call(null,a)},function(a){c.setCurrentUser({}),d.call(null,a)})},this.getContactsFromDb=function(a,b,d){var e="/api/contacts/"+a;c.doAjax(e,"GET",{},function(a){a.errMsg?c.setUserContacts([]):c.setUserContacts(a.contact_list),b.call(null,a)},function(a){c.setUserContacts([]),d.call(null,a)})},this.addUserContacts=function(a,b,d){var e="/api/contacts";c.doAjax(e,"POST",a,function(a){a.errMsg?c.setUserContacts([]):c.setUserContacts(a.contact_list),b.call(null,a)},function(a){c.setUserContacts([]),d.call(null,a)})},this.addNewEvent=function(a,b,d){var e="/api/events";c.doAjax(e,"POST",a,function(a){b.call(null,a)},function(a){d.call(null,a)})},this.getEventsFromDb=function(a,b,d){var e="/api/events/"+a;c.doAjax(e,"GET",{},b,d)},this.setUserContacts=function(a){this.userContacts=JSON.parse(JSON.stringify(a))},this.getUserContacts=function(){return this.userContacts},this.setTargetData=function(a){return this.targetData=JSON.parse(JSON.stringify(a))},this.getTargetData=function(){return this.targetData},this.setCurrentUser=function(a){return this.currentUser=JSON.parse(JSON.stringify(a))},this.getCurrentUser=function(){return this.currentUser},this.setDestination=function(a){return this.destination=JSON.parse(JSON.stringify(a))},this.getDestination=function(){return this.destination},this.setEventData=function(a){this.selectedEvent=JSON.parse(JSON.stringify(a))},this.getEventData=function(){return this.selectedEvent},this.setAddedUsers=function(a){this.getAddedUsers=JSON.parse(JSON.stringify(a))},this.getAddedUsers=function(){return this.getAddedUsers},this.setEventName=function(a){this.eventName=a},this.getEventName=function(){return this.eventName},this.setRecentlySearchedData=function(a){this.getRecentSearches=JSON.parse(JSON.stringify(a))},this.getRecentlySearchedData=function(){return this.getRecentSearches}}]),app.directive("headerTemplate",function(){return{restrict:"E",templateUrl:"partials/header.html",controller:"headerController"}}),app.controller("contactListController",["$scope","$state","SharedDataService",function(a,b,c){a.userContacts=c.getUserContacts(),a.previousPage=function(){b.go("newEvent")},a.addedUsers=[],a.addContacts=function(){angular.forEach(a.userContacts,function(b,c){b.checked&&a.addedUsers.push(b)}),c.setAddedUsers(a.addedUsers),b.go("newEvent")}}]),app.controller("headerController",["$scope","SharedDataService",function(a,b){}]),app.controller("homeController",["$scope","$state","SharedDataService",function(a,b,c){function d(a){for(var b="",c="",d=0;d<a.length;d++){var e=a[d].name;if(1==a.length){b=e;break}if(a.length<=4){if(!a[d+1]){c+=" and "+e,b=c;break}c+=e,a[d+2]&&(c+=", ")}else{if(!(3>=d)){var f=a.length-d;c+=" and "+f+" more",b=c;break}c+=e,3>d&&(c+=", ")}}return b}a.currentUser=c.getCurrentUser(),a.upcomingEvents=[],a.allEvents=[],c.getEventsFromDb(a.currentUser.user_id,function(b){var c=a.currentUser.user_id,e=[],f=[];angular.forEach(b,function(a,b){for(var g=a.invitee_list,h=0;h<g.length;h++)c==g[h].user_id&&("ACCEPTED"==g[h].status?a.status="accepted":"PENDING"==$inviteeList[h].status?(a.status="pending",a.customisedInviteeList=d(a.inviteeList)):a.status="rejected");var i=new Date(a.event_date);i>=new Date&&f.push(a);var j=new Date;i.getDate()==j.getDate()&&i.getMonth()==j.getMonth()&&i.getFullYear()==j.getFullYear()?a.displayDate="Today":a.displayDate=i,e.push(a)}),a.allEvents=e,a.upcomingEvents=f},function(a){}),a.getEventDetails=function(a){c.setEventData(a),b.go("navigation")}}]),app.controller("inviteeListController",["$scope","SharedDataService",function(a,b){a.selectedEvent=b.getEventData(),a.inviteeList=a.selectedEvent.invitee_list,a.statusText,a.mystatus="";for(var c=0;c<a.inviteeList.length;c++)"accepted"==a.inviteeList[c].status?a.inviteeList[c].statusClass="accepted":"pending"==a.inviteeList[c].status?a.inviteeList[c].statusClass="pending":a.inviteeList[c].statusClass="rejected";"pending"==a.selectedEvent.status?(a.statusText="You haven't dicided yet",a.status="pending"):"accepted"==a.selectedEvent.status?(a.statusText="You are going to this event",a.status="accepted"):a.status="rejected"}]),app.controller("landingController",["$scope","$state","SharedDataService",function(a,b,c){!function(){if(localStorage&&null!=localStorage.getItem("registeredUser")){var a=localStorage.getItem("registeredUser");c.getUserInfoFromDb(a,function(d){c.getContactsFromDb(a,function(a){b.go("home")},function(a){})},function(a){localStorage.removeItem("registeredUser")})}else b.go("login")}()}]),app.controller("locationController",["$scope","$state","SharedDataService",function(a,b,c){a.inputText=document.getElementById("pac-input"),a.searchBox=new google.maps.places.SearchBox(a.inputText),a.location="",a.recentSearchedPlaces=c.getRecentlySearchedData(),a.recentSearchedPlaces?a.recentSearchedPlaces:a.recentSearchedPlaces=[],a.searchBox.addListener("places_changed",function(){a.places=a.searchBox.getPlaces(),a.location=a.places[0].name+", "+a.places[0].formatted_address,0!=a.places.length&&a.places.forEach(function(b){a.targetName=b.name,a.targetLocation={lat:b.geometry.location.lat(),lng:b.geometry.location.lng()},c.setTargetData(a.targetLocation)})}),a.setLocation=function(){c.setDestination(a.location),a.setRecentSearch(),b.go("newEvent")},a.setRecentSearch=function(){a.recentSearchedPlaces.push(a.targetName),c.setRecentlySearchedData(a.recentSearchedPlaces)}}]),app.controller("loginController",["$scope","$state","SharedDataService",function(a,b,c){function d(a){function b(b){angular.forEach(b,function(a,b){var c={};c.name=a.name.firstName+(a.name.lastName?a.name.lastName:""),c.contact_id=a.phoneNumbers[0].number,c.profile_pic=a.photoURI?a.photoURI:"",d.push(c)}),a.apply(null,[d])}function c(b){console.log("The following error occurred: "+b.name),a.apply(null,[d])}var d=[],e=[];if("undefined"!=typeof tizen)e=tizen.contact.getDefaultAddressBook(),e.find(b,c);else{var f={},g={};f.name="Charan Adiga",f.contact_id="919878721704",f.profile_pic="",g.name="Archit Soni",g.contact_id="918972721704",g.profile_pic="",d.push(f),d.push(g),a.apply(null,[d])}}a.doRegister=function(){var e={},f=a.phoneNo;""!=a.userName&&""!=a.phoneNo&&(e.name=a.userName,e.user_id=f,c.registerUser(e,function(e){localStorage.setItem("registeredUser",a.phoneNo),d(function(a){var d={};d.contact_list=a,d.user_id=f,c.addUserContacts(d,function(a){b.go("home")},function(a){})})},function(a){localStorage.removeItem("registeredUser"),alert("Unable to Register")}))}}]),app.controller("navigationController",["$scope","$state","SharedDataService",function(a,b,c){function d(){for(var b,c="",d=a.selectedEvent.invitee_list,e=0;e<d.length;e++){var f=d[e].name;if(1==d.length){c=f;break}if(d.length<=4){if(!d[e+1]){b+=" and "+f,c=b;break}b+=f,d[e+2]&&(b+=", ")}else{if(!(3>=e)){var g=d.length-e;b+=" and "+g+" more",c=b;break}b+=f,3>e&&(b+=", ")}}a.customisedInviteeList=c}function e(){k=new google.maps.Map(document.getElementById("map"),{center:a.targetLocation,scrollwheel:!0,zoom:13,mapTypeId:google.maps.MapTypeId.ROADMAP,disableDefaultUI:!0});var b=(new google.maps.Marker({position:a.targetLocation,map:k}),document.createElement("div"));b.style.padding="0px 0px 20px 0px";new g(b,k);k.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(b)}function f(){m.setDirections(p)}function g(a,b){var c=document.createElement("div");c.setAttribute("id","mapdirectionBtn"),c.style.backgroundColor="#493073",c.style.border="2px solid #493073",c.style.borderRadius="10px",c.style.marginRight="12px",c.style.textAlign="center",a.appendChild(c);var d=document.createElement("div");d.style.color="white",d.style.fontSize="16px",d.style.paddingLeft="5px",d.style.paddingRight="5px",d.innerHTML="Directions",c.appendChild(d),c.addEventListener("click",function(){f()})}function h(a){return{path:"M0-48c-9.8 0-17.7 7.8-17.7 17.4 0 15.5 17.7 30.6 17.7 30.6s17.7-15.4 17.7-30.6c0-9.6-7.9-17.4-17.7-17.4z",fillColor:a,fillOpacity:1,strokeColor:"#000",strokeWeight:1,scale:1}}function i(){l=new MarkerWithLabel({position:o,map:k,labelContent:"You",labelAnchor:new google.maps.Point(10,45),labelClass:"labels",labelInBackground:!1,icon:h("#00387B")})}function j(){m=new google.maps.DirectionsRenderer({map:k,suppressMarkers:!0});var b={origin:o,destination:a.targetLocation,travelMode:google.maps.TravelMode.DRIVING};n=new google.maps.DirectionsService,n.route(b,function(a,b){b==google.maps.DirectionsStatus.OK&&(p=a)})}var k,l,m,n,o,p;a.selectedEvent=c.getEventData(),a.currentUser=c.getCurrentUser(),a.targetLocation=a.selectedEvent.coordinates,a.toggleStartBtn=!0,a.enableTrackBtn="ACCEPTED"==a.selectedEvent.mystatus,a.customisedInviteeList="",a.arrivedPpl=[],a.showAnimation=!1,a.trackingMode=!1,a.updateSelectedEventStatus=function(){var b=a.selectedEvent;"ACCEPTED"==b.mystatus?b.statusClass="accepted":"PENDING"==b.mystatus?b.statusClass="pending":b.statusClass="rejected";var c=new Date(b.eventDate),e=new Date;c.getDate()==e.getDate()&&c.getMonth()==e.getMonth()&&c.getFullYear()==e.getFullYear()?b.eventDate="Today":b.eventDate=c,d()},a.updateSelectedEventStatus(),function(){navigator.geolocation.getCurrentPosition(function(a){o={lat:a.coords.latitude,lng:a.coords.longitude},e(),i(),j()})}()}]),app.controller("newEventController",["$scope","$state","SharedDataService",function(a,b,c){function d(a,b){var c=new google.maps.Geocoder;c.geocode({address:a},function(a,c){if(c==google.maps.GeocoderStatus.OK){var d={lat:a[0].geometry.location.lat(),lng:a[0].geometry.location.lng()};b(d)}else b(null)})}a.invitees=c.getAddedUsers,a.location=c.getDestination(),a.currentUser=c.getCurrentUser(),a.addedUsers="",a.eventName=c.getEventName(),a.eventName?a.eventName:a.eventName="",angular.forEach(a.invitees,function(b,c){c==a.invitees.length-1?a.addedUsers+=b.name:a.addedUsers+=b.name+" / "});var e=new Date,f=e.getHours(),g=(e.getMinutes()<10?"0":"")+e.getMinutes(),h=f>=12?"p.m.":"a.m.",i=f>=12?f-12:f;a.eventTime=i+":"+g+" "+h,a.eventDate=e,a.updateEventName=function(){c.setEventName(a.eventName)},a.createNewEvent=function(){""!=a.eventName||""==a.location||""==a.eventDate||(a.eventTime="")||0==a.invitees.length?d(a.location,function(d){if(d){var e={};e.title=a.eventName,e.location=a.location,e.coordinates=d,e.event_date=a.eventDate.toDateString(),e.event_time=a.eventTime;var f=[];angular.forEach(a.invitees,function(a){var b={};b.name=a.name,b.user_id=a.contact_id,b.status="PENDING",f.push(b)});var g={};g.name=a.currentUser.name,g.user_id=a.currentUser.user_id,g.status="ACCEPTED",f.push(g),e.user_id=a.currentUser.user_id,e.invitee_list=f,c.addNewEvent(e,function(a){b.go("home")},function(a){alert("Failed to create event")})}else alert("Unable to get location coordinates")}):alert("Please fill required fileds")}}]);