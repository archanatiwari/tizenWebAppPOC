app.factory("SharedFactory",["$http",function(a){var b=function(){return a.get("data/user-data.json").then(function(a){return a.data.data},function(a){return console.log("error in fetching"+a.status),[]})};return{getData:b}}]),app.service("SharedDataService",["$http","$timeout",function(a,b){this.jsonData=[];var c=this,d=!1;this.apiDomain="http://localhost:8080",function(){d=!0,a.get("data/user-data.json").then(function(a){d=!1,c.jsonData=a.data.data},function(a){console.log("error in fetching"+a.status),d=!1,c.jsonData})}(),this.getJsonData=function(a){d?b(function(){c.getJsonData(a)},50):a.apply(null,[c.jsonData])},this.registerUser=function(a,b,d){var e="/api/users";c.doAjax(e,"POST",a,function(a){var d={userName:a.user_name,userId:a.user_id};c.setCurrentUser(d),b.call(null,a)},function(a){c.setCurrentUser({}),d.call(null,a)})},this.getUserInfoFromDb=function(a,b,d){var e="/api/users/"+a;c.doAjax(e,"GET",{},function(a){var d={userName:a.name,userId:a.user_id};c.setCurrentUser(d),b.call(null,a)},function(a){c.setCurrentUser({}),d.call(null,a)})},this.addUserContacts=function(a,b,d){var e="/api/contacts";c.doAjax(e,"POST",a,b,d)},this.getUserEvents=function(a,b,d){var e="/api/events/"+a;c.doAjax(e,"GET",{},b,d)},this.setTargetData=function(a){return this.targetData=a},this.getTargetData=function(){return this.targetData},this.setCurrentUser=function(a){return this.currentUser=a},this.getCurrentUser=function(){return this.currentUser},this.setDestination=function(a){return this.destination=a},this.getDestination=function(){return this.destination},this.setEventData=function(a){this.selectedEvent=a},this.getEventData=function(){return this.selectedEvent},this.setAddedUsers=function(a){this.getAddedUsers=a},this.getAddedUsers=function(){return this.getAddedUsers},this.setEventName=function(a){this.eventName=a},this.getEventName=function(){return this.eventName},this.setRecentlySearchedData=function(a){this.getRecentSearches=a},this.getRecentlySearchedData=function(){return this.getRecentSearches},this.doAjax=function(a,b,d,e,f){$.ajax({type:b,url:c.apiDomain+a,data:d,success:function(a,b){"success"!=b||a.errmsg?f.call(null,a):e.call(null,a)}})}}]),app.directive("headerTemplate",function(){return{restrict:"E",templateUrl:"partials/header.html",controller:"headerController"}}),app.controller("contactListController",["$scope","$state","SharedFactory","SharedDataService",function(a,b,c,d){c.getData().then(function(b){a.userContacts=b},function(b){a.userContacts=b}),a.previousPage=function(){b.go("newEvent")},a.addedUsers=[],a.addContacts=function(){angular.forEach(a.userContacts,function(b,c){b.checked&&a.addedUsers.push(b.name)}),d.setAddedUsers(a.addedUsers),b.go("newEvent")}}]),app.controller("headerController",["$scope","SharedDataService",function(a,b){}]),app.controller("homeController",["$scope","$state","SharedDataService",function(a,b,c){function d(a){for(var b="",c="",d=0;d<a.length;d++){var e=a[d].name;if(1==a.length){b=e;break}if(a.length<=4){if(!a[d+1]){c+=" and "+e,b=c;break}c+=e,a[d+2]&&(c+=", ")}else{if(!(3>=d)){var f=a.length-d;c+=" and "+f+" more",b=c;break}c+=e,3>d&&(c+=", ")}}return b}a.currentUser=c.getCurrentUser(),a.upcomingEvents=[],a.allEvents=[],c.getUserEvents(a.currentUser.userId,function(b){var c=a.currentUser.user_id,e=[],f=[];b.forEach(function(a,b){for(var g=a.invitee_list,h=0;h<g.length;h++)c==g[h].user_id&&("ACCEPTED"==g[h].status?a.statusClass="accepted":"PENDING"==$inviteeList[h].status?(a.statusClass="pending",a.customisedInviteeList=d(a.inviteeList)):a.statusClass="rejected");var i=new Date(a.event_date);i>=new Date&&f.push(a);var j=new Date;i.getDate()==j.getDate()&&i.getMonth()==j.getMonth()&&i.getFullYear()==j.getFullYear()?a.displayDate="Today":a.displayDate=i,e.push(a)}),a.allEvents=e,a.upcomingEvents=f},function(a){}),a.getEventDetails=function(a){c.setEventData(a),b.go("navigation")}}]),app.controller("inviteeListController",["$scope","SharedDataService",function(a,b){a.selectedEvent=b.getEventData(),a.inviteeList=a.selectedEvent.inviteeList,a.statusText,a.mystatus="";for(var c=0;c<a.inviteeList.length;c++)"ACCEPTED"==a.inviteeList[c].status?a.inviteeList[c].statusClass="accepted":"PENDING"==a.inviteeList[c].status?a.inviteeList[c].statusClass="pending":a.inviteeList[c].statusClass="rejected";"PENDING"==a.selectedEvent.mystatus?(a.statusText="You haven't dicided yet",a.mystatus="pending"):"ACCEPTED"==a.selectedEvent.mystatus?(a.statusText="You are going to this event",a.mystatus="accepted"):a.mystatus="rejected"}]),app.controller("landingController",["$scope","$state","SharedDataService",function(a,b,c){!function(){if(localStorage&&null!=localStorage.getItem("registeredUser")){var a=localStorage.getItem("registeredUser");c.getUserInfoFromDb(a,function(a){b.go("home")},function(a){localStorage.removeItem("registeredUser")})}else b.go("login")}()}]),app.controller("locationController",["$scope","$state","SharedDataService",function(a,b,c){a.inputText=document.getElementById("pac-input"),a.searchBox=new google.maps.places.SearchBox(a.inputText),a.location="",a.newEventName=c.getEventName(),a.recentSearchedPlaces=c.getRecentlySearchedData(),a.recentSearchedPlaces?a.recentSearchedPlaces:a.recentSearchedPlaces=[],a.searchBox.addListener("places_changed",function(){a.places=a.searchBox.getPlaces(),a.location=a.places[0].name+", "+a.places[0].formatted_address,0!=a.places.length&&a.places.forEach(function(b){a.targetName=b.name,a.targetLocation={lat:b.geometry.location.lat(),lng:b.geometry.location.lng()},c.setTargetData(a.targetLocation)})}),a.currentUser=c.getCurrentUser(),a.setLocation=function(){c.setDestination(a.location),b.go("newEvent")},a.setRecentSearch=function(){a.recentSearchedPlaces.push(a.targetName),c.setRecentlySearchedData(a.recentSearchedPlaces)}}]),app.controller("loginController",["$scope","$state","SharedFactory","SharedDataService",function(a,b,c,d){function e(a){function b(b){b.forEach(function(a,b){var c={};c.name=a.name.firstName+(a.name.lastName?a.name.lastName:""),c.contact_id=a.phoneNumbers[0].number,c.profile_pic=a.photoURI?a.photoURI:"",d.push(c)}),a.apply(null,[d])}function c(b){console.log("The following error occurred: "+b.name),a.apply(null,[d])}var d=[],e=[];if("undefined"!=typeof tizen)e=tizen.contact.getDefaultAddressBook(),e.find(b,c);else{var f={},g={};f.name="Charan Adiga",f.contact_id="919878721704",f.profile_pic="",g.name="Archit Soni",g.contact_id="918972721704",g.profile_pic="",d.push(f),d.push(g),a.apply(null,[d])}}a.doRegister=function(){var c={},f=a.phoneNo;""!=a.userName&&""!=a.phoneNo&&(c.name=a.userName,c.user_id=f,d.registerUser(c,function(c){localStorage.setItem("registeredUser",a.phoneNo),e(function(a){var c={};c.contact_list=a,c.user_id=f,d.addUserContacts(c,function(a){b.go("home")},function(a){})})},function(a){localStorage.removeItem("registeredUser"),alert("Unable to Register")}))}}]),app.controller("navigationController",["$scope","$interval","$state","SharedFactory","SharedDataService",function(a,b,c,d,e){function f(b,c){var d=document.createElement("div");d.setAttribute("id","mapdirectionBtn"),d.style.backgroundColor="#493073",d.style.border="2px solid #493073",d.style.borderRadius="10px",d.style.marginRight="12px",d.style.textAlign="center",b.appendChild(d);var e=document.createElement("div");e.style.color="white",e.style.fontSize="16px",e.style.paddingLeft="5px",e.style.paddingRight="5px",e.innerHTML="Directions",d.appendChild(e),d.addEventListener("click",function(){a.getDirections()})}function g(a){return{path:"M0-48c-9.8 0-17.7 7.8-17.7 17.4 0 15.5 17.7 30.6 17.7 30.6s17.7-15.4 17.7-30.6c0-9.6-7.9-17.4-17.7-17.4z",fillColor:a,fillOpacity:1,strokeColor:"#000",strokeWeight:1,scale:1}}var h,i=-1,j=0;a.selectedEvent=e.getEventData(),a.targetLocation=a.selectedEvent.destination,a.toggleStartBtn=!0,a.enableTrackBtn="ACCEPTED"==a.selectedEvent.mystatus,a.customisedInviteeList="",a.arrivedPpl=[],a.showAnimation=!1,a.trackingMode=!1;for(var k=a.selectedEvent.inviteeList,l="",m=0;m<k.length;m++){var n=k[m].name;if(1==k.length){a.customisedInviteeList=n;break}if(k.length<=4){if(!k[m+1]){l+=" and "+n,a.customisedInviteeList=l;break}l+=n,k[m+2]&&(l+=", ")}else{if(!(3>=m)){var o=k.length-m;l+=" and "+o+" more",a.customisedInviteeList=l;break}l+=n,3>m&&(l+=", ")}}a.updateSelectedEventStatus=function(){var b=a.selectedEvent;"ACCEPTED"==b.mystatus?b.statusClass="accepted":"PENDING"==b.mystatus?b.statusClass="pending":b.statusClass="rejected";var c=new Date(b.eventDate),d=new Date;c.getDate()==d.getDate()&&c.getMonth()==d.getMonth()&&c.getFullYear()==d.getFullYear()?b.eventDate="Today":b.eventDate=c},a.updateSelectedEventStatus();var p=function(b){a.userList=b,a.currentUser=e.getCurrentUser(),a.updateCurrentUserPosition(),a.getCoordinates()},q=function(b){a.userList=b};d.getData().then(p,q);var r,s,t,u=new google.maps.Map(document.getElementById("map"),{center:a.targetLocation,scrollwheel:!0,zoom:13,mapTypeId:google.maps.MapTypeId.ROADMAP,disableDefaultUI:!0}),v=(new google.maps.Marker({position:a.targetLocation,map:u}),document.createElement("div"));v.style.padding="0px 0px 20px 0px";new f(v,u);u.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(v),a.updateCurrentUserPosition=function(){r=new MarkerWithLabel({position:a.currentUser.source,map:u,labelContent:"You",labelAnchor:new google.maps.Point(10,45),labelClass:"labels",labelInBackground:!1,icon:g("#00387B")})},a.getCoordinates=function(){var b=a.userList,c=a.currentUser;b.forEach(function(d,e){s=new google.maps.DirectionsRenderer({map:u,suppressMarkers:!0});var f={origin:b[e].source,destination:a.targetLocation,travelMode:google.maps.TravelMode.DRIVING};t=new google.maps.DirectionsService,t.route(f,function(d,f){f==google.maps.DirectionsStatus.OK&&(c.source.lat==d.request.origin.lat&&c.source.lng==d.request.origin.lng&&(a.currentUser.route=d),b[e].destination=a.targetLocation,b[e].positions=d.routes[0].overview_path)})})},a.updateUserPosition=function(){var c=a.userList,d=a.targetLocation;c.forEach(function(e,f){var k=e,l=k.positions;if(l[i]){var m=l[i].lat(),n=l[i].lng(),o=new google.maps.LatLng(m,n);if(k.marker)k.marker.setPosition(o);else if(k.id==a.currentUser.id)k.marker=new MarkerWithLabel({position:o,map:u,labelContent:"You",labelAnchor:new google.maps.Point(10,45),labelClass:"labels",labelInBackground:!1,icon:g("#00387B")});else{var p=k.name.split(" "),q=p.length>1?p[0].charAt(0)+p[1].charAt(0):p[0].charAt(0);k.marker=new MarkerWithLabel({position:o,map:u,labelContent:q,labelAnchor:new google.maps.Point(10,45),labelClass:"labels",labelInBackground:!1,icon:g("#493073")})}}else if(d.lat===k.destination.lat&&d.lng===k.destination.lng&&!k.reached){k.reached=!0,j++;var p=k.name.split(" "),q=p.length>1?p[0].charAt(0)+p[1].charAt(0):p[0].charAt(0),r={name:k.name,label:q};a.arrivedPpl.push(r),k.marker.setMap(null),j==c.length&&(a.showAnimation=!0,a.trackingMode=!1,a.enableTrackBtn=!1,i=-1,b.cancel(h))}})},a.trackUserPosition=function(){h=b(function(){i++,a.updateUserPosition()},1e3)},a.stopTracking=function(){i=-1,b.cancel(h),a.userList.forEach(function(a,b){a.marker.setMap(null),a.marker=null,a.reached=null}),j=0,a.showAnimation=!1,a.trackingMode=!1,a.arrivedPpl=[],a.toggleStartBtn=!0,a.updateCurrentUserPosition()},a.trackUsers=function(){var b=document.getElementById("mapdirectionBtn");b&&(b.style.display="none"),s.setMap(null),r.setMap(null),a.trackingMode=!0,a.toggleStartBtn=!1,a.trackUserPosition()},a.getDirections=function(){s.setDirections(a.currentUser.route)}}]),app.controller("newEventController",["$scope","SharedDataService",function(a,b){a.users=b.getAddedUsers,a.location=b.getDestination(),a.eventName=b.getEventName(),a.eventName?a.eventName:a.eventName="",a.updateEventName=function(){b.setEventName(a.eventName)},0!=a.users.length&&(a.addedUsers=a.users.join(" / "));var c=new Date,d=c.getHours(),e=(c.getMinutes()<10?"0":"")+c.getMinutes(),f=d>=12?"p.m.":"a.m.",g=d>=12?d-12:d;a.eventTime=g+":"+e+" "+f,a.eventDate=c}]);