app.service("SharedDataService",["$http","$timeout",function(a,b){this.jsonData=[];var c=this;this.apiDomain="http://localhost:8080",this.registerUser=function(a,b,d){var e="/api/users";c.doAjax(e,"POST",a,function(a){var d={name:a.user_name,user_id:a.user_id};c.setCurrentUser(d),b.call(null,a)},function(a){c.setCurrentUser({}),d.call(null,a)})},this.getUserInfoFromDb=function(a,b,d){var e="/api/users/"+a;c.doAjax(e,"GET",{},function(a){if(a.errMsg)c.setCurrentUser({});else{var d={name:a.name,user_id:a.user_id};c.setCurrentUser(d)}b.call(null,a)},function(a){c.setCurrentUser({}),d.call(null,a)})},this.getContactsFromDb=function(a,b,d){var e="/api/contacts/"+a;c.doAjax(e,"GET",{},function(a){a.errMsg?c.setUserContacts([]):c.setUserContacts(a.contact_list),b.call(null,a)},function(a){c.setUserContacts([]),d.call(null,a)})},this.addUserContacts=function(a,b,d){var e="/api/contacts";c.doAjax(e,"POST",a,function(a){a.errMsg?c.setUserContacts([]):c.setUserContacts(a.contact_list),b.call(null,a)},function(a){c.setUserContacts([]),d.call(null,a)})},this.addNewEvent=function(a,b,d){var e="/api/events";c.doAjax(e,"POST",a,function(a){b.call(null,a)},function(a){d.call(null,a)})},this.getUserEvents=function(a,b,d){var e="/api/events/"+a;c.doAjax(e,"GET",{},b,d)},this.setUserContacts=function(a){this.userContacts=JSON.parse(JSON.stringify(a))},this.getUserContacts=function(){return this.userContacts},this.setTargetData=function(a){return this.targetData=JSON.parse(JSON.stringify(a))},this.getTargetData=function(){return this.targetData},this.setCurrentUser=function(a){return this.currentUser=JSON.parse(JSON.stringify(a))},this.getCurrentUser=function(){return this.currentUser},this.setDestination=function(a){return this.destination=JSON.parse(JSON.stringify(a))},this.getDestination=function(){return this.destination},this.setEventData=function(a){this.selectedEvent=JSON.parse(JSON.stringify(a))},this.getEventData=function(){return this.selectedEvent},this.setAddedUsers=function(a){this.getAddedUsers=JSON.parse(JSON.stringify(a))},this.getAddedUsers=function(){return this.getAddedUsers},this.setEventName=function(a){this.eventName=a},this.getEventName=function(){return this.eventName},this.setRecentlySearchedData=function(a){this.getRecentSearches=JSON.parse(JSON.stringify(a))},this.getRecentlySearchedData=function(){return this.getRecentSearches},this.doAjax=function(a,b,d,e,f){$.ajax({type:b,url:c.apiDomain+a,data:d,success:function(a,b){"success"==b?null==a?e.call(null,{errMsg:"no results"}):a.errors?e.call(null,{errMsg:"error while getting results"}):e.call(null,a):f.call(null,a)}})}}]),app.directive("headerTemplate",function(){return{restrict:"E",templateUrl:"partials/header.html",controller:"headerController"}}),app.controller("contactListController",["$scope","$state","SharedDataService",function(a,b,c){a.userContacts=c.getUserContacts(),a.previousPage=function(){b.go("newEvent")},a.addedUsers=[],a.addContacts=function(){angular.forEach(a.userContacts,function(b,c){b.checked&&a.addedUsers.push(b)}),c.setAddedUsers(a.addedUsers),b.go("newEvent")}}]),app.controller("headerController",["$scope","SharedDataService",function(a,b){}]),app.controller("homeController",["$scope","$state","SharedDataService",function(a,b,c){function d(a){for(var b="",c="",d=0;d<a.length;d++){var e=a[d].name;if(1==a.length){b=e;break}if(a.length<=4){if(!a[d+1]){c+=" and "+e,b=c;break}c+=e,a[d+2]&&(c+=", ")}else{if(!(3>=d)){var f=a.length-d;c+=" and "+f+" more",b=c;break}c+=e,3>d&&(c+=", ")}}return b}a.currentUser=c.getCurrentUser(),a.upcomingEvents=[],a.allEvents=[],c.getUserEvents(a.currentUser.user_id,function(b){var c=a.currentUser.user_id,e=[],f=[];angular.forEach(b,function(a,b){for(var g=a.invitee_list,h=0;h<g.length;h++)c==g[h].user_id&&("ACCEPTED"==g[h].status?a.statusClass="accepted":"PENDING"==$inviteeList[h].status?(a.statusClass="pending",a.customisedInviteeList=d(a.inviteeList)):a.statusClass="rejected");var i=new Date(a.event_date);i>=new Date&&f.push(a);var j=new Date;i.getDate()==j.getDate()&&i.getMonth()==j.getMonth()&&i.getFullYear()==j.getFullYear()?a.displayDate="Today":a.displayDate=i,e.push(a)}),a.allEvents=e,a.upcomingEvents=f},function(a){}),a.getEventDetails=function(a){c.setEventData(a),b.go("navigation")}}]),app.controller("inviteeListController",["$scope","SharedDataService",function(a,b){a.selectedEvent=b.getEventData(),a.inviteeList=a.selectedEvent.inviteeList,a.statusText,a.mystatus="";for(var c=0;c<a.inviteeList.length;c++)"ACCEPTED"==a.inviteeList[c].status?a.inviteeList[c].statusClass="accepted":"PENDING"==a.inviteeList[c].status?a.inviteeList[c].statusClass="pending":a.inviteeList[c].statusClass="rejected";"PENDING"==a.selectedEvent.mystatus?(a.statusText="You haven't dicided yet",a.mystatus="pending"):"ACCEPTED"==a.selectedEvent.mystatus?(a.statusText="You are going to this event",a.mystatus="accepted"):a.mystatus="rejected"}]),app.controller("landingController",["$scope","$state","SharedDataService",function(a,b,c){!function(){if(localStorage&&null!=localStorage.getItem("registeredUser")){var a=localStorage.getItem("registeredUser");c.getUserInfoFromDb(a,function(d){c.getContactsFromDb(a,function(a){b.go("home")},function(a){})},function(a){localStorage.removeItem("registeredUser")})}else b.go("login")}()}]),app.controller("locationController",["$scope","$state","SharedDataService",function(a,b,c){a.inputText=document.getElementById("pac-input"),a.searchBox=new google.maps.places.SearchBox(a.inputText),a.location="",a.recentSearchedPlaces=c.getRecentlySearchedData(),a.recentSearchedPlaces?a.recentSearchedPlaces:a.recentSearchedPlaces=[],a.searchBox.addListener("places_changed",function(){a.places=a.searchBox.getPlaces(),a.location=a.places[0].name+", "+a.places[0].formatted_address,0!=a.places.length&&a.places.forEach(function(b){a.targetName=b.name,a.targetLocation={lat:b.geometry.location.lat(),lng:b.geometry.location.lng()},c.setTargetData(a.targetLocation)})}),a.setLocation=function(){c.setDestination(a.location),a.setRecentSearch(),b.go("newEvent")},a.setRecentSearch=function(){a.recentSearchedPlaces.push(a.targetName),c.setRecentlySearchedData(a.recentSearchedPlaces)}}]),app.controller("loginController",["$scope","$state","SharedDataService",function(a,b,c){function d(a){function b(b){angular.forEach(b,function(a,b){var c={};c.name=a.name.firstName+(a.name.lastName?a.name.lastName:""),c.contact_id=a.phoneNumbers[0].number,c.profile_pic=a.photoURI?a.photoURI:"",d.push(c)}),a.apply(null,[d])}function c(b){console.log("The following error occurred: "+b.name),a.apply(null,[d])}var d=[],e=[];if("undefined"!=typeof tizen)e=tizen.contact.getDefaultAddressBook(),e.find(b,c);else{var f={},g={};f.name="Charan Adiga",f.contact_id="919878721704",f.profile_pic="",g.name="Archit Soni",g.contact_id="918972721704",g.profile_pic="",d.push(f),d.push(g),a.apply(null,[d])}}a.doRegister=function(){var e={},f=a.phoneNo;""!=a.userName&&""!=a.phoneNo&&(e.name=a.userName,e.user_id=f,c.registerUser(e,function(e){localStorage.setItem("registeredUser",a.phoneNo),d(function(a){var d={};d.contact_list=a,d.user_id=f,c.addUserContacts(d,function(a){b.go("home")},function(a){})})},function(a){localStorage.removeItem("registeredUser"),alert("Unable to Register")}))}}]),app.controller("navigationController",["$scope","$interval","$state","SharedDataService",function(a,b,c,d){function e(b,c){var d=document.createElement("div");d.setAttribute("id","mapdirectionBtn"),d.style.backgroundColor="#493073",d.style.border="2px solid #493073",d.style.borderRadius="10px",d.style.marginRight="12px",d.style.textAlign="center",b.appendChild(d);var e=document.createElement("div");e.style.color="white",e.style.fontSize="16px",e.style.paddingLeft="5px",e.style.paddingRight="5px",e.innerHTML="Directions",d.appendChild(e),d.addEventListener("click",function(){a.getDirections()})}function f(a){return{path:"M0-48c-9.8 0-17.7 7.8-17.7 17.4 0 15.5 17.7 30.6 17.7 30.6s17.7-15.4 17.7-30.6c0-9.6-7.9-17.4-17.7-17.4z",fillColor:a,fillOpacity:1,strokeColor:"#000",strokeWeight:1,scale:1}}var g,h=-1,i=0;a.selectedEvent=d.getEventData(),a.targetLocation=a.selectedEvent.destination,a.toggleStartBtn=!0,a.enableTrackBtn="ACCEPTED"==a.selectedEvent.mystatus,a.customisedInviteeList="",a.arrivedPpl=[],a.showAnimation=!1,a.trackingMode=!1;for(var j=a.selectedEvent.inviteeList,k="",l=0;l<j.length;l++){var m=j[l].name;if(1==j.length){a.customisedInviteeList=m;break}if(j.length<=4){if(!j[l+1]){k+=" and "+m,a.customisedInviteeList=k;break}k+=m,j[l+2]&&(k+=", ")}else{if(!(3>=l)){var n=j.length-l;k+=" and "+n+" more",a.customisedInviteeList=k;break}k+=m,3>l&&(k+=", ")}}a.updateSelectedEventStatus=function(){var b=a.selectedEvent;"ACCEPTED"==b.mystatus?b.statusClass="accepted":"PENDING"==b.mystatus?b.statusClass="pending":b.statusClass="rejected";var c=new Date(b.eventDate),d=new Date;c.getDate()==d.getDate()&&c.getMonth()==d.getMonth()&&c.getFullYear()==d.getFullYear()?b.eventDate="Today":b.eventDate=c},a.updateSelectedEventStatus();var o,p,q,r=new google.maps.Map(document.getElementById("map"),{center:a.targetLocation,scrollwheel:!0,zoom:13,mapTypeId:google.maps.MapTypeId.ROADMAP,disableDefaultUI:!0}),s=(new google.maps.Marker({position:a.targetLocation,map:r}),document.createElement("div"));s.style.padding="0px 0px 20px 0px";new e(s,r);r.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(s),a.updateCurrentUserPosition=function(){o=new MarkerWithLabel({position:a.currentUser.source,map:r,labelContent:"You",labelAnchor:new google.maps.Point(10,45),labelClass:"labels",labelInBackground:!1,icon:f("#00387B")})},a.getCoordinates=function(){var b=a.userList,c=a.currentUser;b.forEach(function(d,e){p=new google.maps.DirectionsRenderer({map:r,suppressMarkers:!0});var f={origin:b[e].source,destination:a.targetLocation,travelMode:google.maps.TravelMode.DRIVING};q=new google.maps.DirectionsService,q.route(f,function(d,f){f==google.maps.DirectionsStatus.OK&&(c.source.lat==d.request.origin.lat&&c.source.lng==d.request.origin.lng&&(a.currentUser.route=d),b[e].destination=a.targetLocation,b[e].positions=d.routes[0].overview_path)})})},a.updateUserPosition=function(){var c=a.userList,d=a.targetLocation;c.forEach(function(e,j){var k=e,l=k.positions;if(l[h]){var m=l[h].lat(),n=l[h].lng(),o=new google.maps.LatLng(m,n);if(k.marker)k.marker.setPosition(o);else if(k.id==a.currentUser.id)k.marker=new MarkerWithLabel({position:o,map:r,labelContent:"You",labelAnchor:new google.maps.Point(10,45),labelClass:"labels",labelInBackground:!1,icon:f("#00387B")});else{var p=k.name.split(" "),q=p.length>1?p[0].charAt(0)+p[1].charAt(0):p[0].charAt(0);k.marker=new MarkerWithLabel({position:o,map:r,labelContent:q,labelAnchor:new google.maps.Point(10,45),labelClass:"labels",labelInBackground:!1,icon:f("#493073")})}}else if(d.lat===k.destination.lat&&d.lng===k.destination.lng&&!k.reached){k.reached=!0,i++;var p=k.name.split(" "),q=p.length>1?p[0].charAt(0)+p[1].charAt(0):p[0].charAt(0),s={name:k.name,label:q};a.arrivedPpl.push(s),k.marker.setMap(null),i==c.length&&(a.showAnimation=!0,a.trackingMode=!1,a.enableTrackBtn=!1,h=-1,b.cancel(g))}})},a.trackUserPosition=function(){g=b(function(){h++,a.updateUserPosition()},1e3)},a.stopTracking=function(){h=-1,b.cancel(g),a.userList.forEach(function(a,b){a.marker.setMap(null),a.marker=null,a.reached=null}),i=0,a.showAnimation=!1,a.trackingMode=!1,a.arrivedPpl=[],a.toggleStartBtn=!0,a.updateCurrentUserPosition()},a.trackUsers=function(){var b=document.getElementById("mapdirectionBtn");b&&(b.style.display="none"),p.setMap(null),o.setMap(null),a.trackingMode=!0,a.toggleStartBtn=!1,a.trackUserPosition()},a.getDirections=function(){p.setDirections(a.currentUser.route)}}]),app.controller("newEventController",["$scope","SharedDataService",function(a,b){function c(a,b){var c=new google.maps.Geocoder;c.geocode({address:a},function(a,c){if(c==google.maps.GeocoderStatus.OK){var d={lat:a[0].geometry.location.lat(),lng:a[0].geometry.location.lng()};b(d)}else b(null)})}a.invitees=b.getAddedUsers,a.location=b.getDestination(),a.currentUser=b.getCurrentUser(),a.addedUsers="",a.eventName=b.getEventName(),a.eventName?a.eventName:a.eventName="",angular.forEach(a.invitees,function(b,c){c==a.invitees.length-1?a.addedUsers+=b.name:a.addedUsers+=b.name+" / "});var d=new Date,e=d.getHours(),f=(d.getMinutes()<10?"0":"")+d.getMinutes(),g=e>=12?"p.m.":"a.m.",h=e>=12?e-12:e;a.eventTime=h+":"+f+" "+g,a.eventDate=d,a.updateEventName=function(){b.setEventName(a.eventName)},a.createNewEvent=function(){""!=a.eventName||""==a.location||""==a.eventDate||(a.eventTime="")||0==a.invitees.length?c(a.location,function(c){if(c){var d={};d.title=a.eventName,d.location=a.location,d.coordinates=c,d.event_date=a.eventDate.toDateString(),d.event_time=a.eventTime;var e=[];angular.forEach(a.invitees,function(a){var b={};b.name=a.name,b.user_id=a.contact_id,b.status="PENDING",e.push(b)});var f={};f.name=a.currentUser.name,f.user_id=a.currentUser.user_id,f.status="ACCEPTED",e.push(f),d.user_id=a.currentUser.user_id,d.invitee_list=e,b.addNewEvent(d,function(a){},function(a){})}else alert("Unable to get location coordinates")}):alert("Please fill required fileds")}}]);